<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Scudual</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-light">
<div class="container my-4">
  <h3 class="text-center mb-4">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø¯ÙŠØ±</h3>

  <!-- âœ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
  <div class="card mb-4">
    <div class="card-header bg-warning">ğŸ“¥ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
    <div class="card-body" id="pendingBookings">
      <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>

  <!-- âœ… Ù…Ù† Ø³ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ… -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">ğŸ¥ Ù…Ù† Ø³ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
    <div class="card-body" id="todayBookings">
      <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>

  <!-- âœ… Ù…Ù† Ø³ÙŠØµÙˆØ± ØºØ¯Ù‹Ø§ -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">ğŸ“… Ù…Ù† Ø³ÙŠØµÙˆØ± ØºØ¯Ù‹Ø§</div>
    <div class="card-body" id="tomorrowBookings">
      <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>

  <!-- âœ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° -->
  <div class="card mb-5">
    <div class="card-header bg-primary text-white">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</div>
    <div class="card-body">
      <form id="addTeacherForm">
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" id="name" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required />
          </div>
          <div class="col-md-4">
            <input type="email" id="email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
          </div>
          <div class="col-md-4">
            <input type="password" id="password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required />
          </div>
          <div class="col-md-4">
            <select id="role" class="form-select" required>
              <option value="teacher">Ø£Ø³ØªØ§Ø°</option>
              <option value="admin">Ù…Ø¯ÙŠØ±</option>
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
      </form>
      <div id="addTeacherMsg" class="mt-3 text-success text-center"></div>
    </div>
  </div>
</div>
<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ ÙØ§ÙŠØ±Ø¨ÙŠØ³
  const firebaseConfig = {
    apiKey: "AIzaSyBsBJNcvaJXiIcJShLiwa-WFtY-VUMGTuk",
    authDomain: "scudual.firebaseapp.com",
    projectId: "scudual"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "index.html";
    } else {
      const userDoc = await db.collection("users").doc(user.uid).get();
      if (!userDoc.exists || userDoc.data().role !== "admin") {
        alert("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§.");
        window.location.href = "index.html";
      } else {
        loadPendingBookings();
        loadTodayBookings();
        loadTomorrowBookings();
      }
    }
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  async function loadPendingBookings() {
    const container = document.getElementById("pendingBookings");
    container.innerHTML = "";
    const snapshot = await db.collection("bookings").where("status", "==", "pending").get();

    if (snapshot.empty) {
      container.innerHTML = "<p class='text-muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
      return;
    }

    snapshot.forEach(async (doc) => {
      const data = doc.data();
      const userSnap = await db.collection("users").doc(data.userId).get();
      const userName = userSnap.exists ? userSnap.data().name : "Ø£Ø³ØªØ§Ø° Ù…Ø¬Ù‡ÙˆÙ„";

      const card = document.createElement("div");
      card.className = "border p-3 rounded mb-3 bg-white d-flex justify-content-between align-items-center";
      card.innerHTML = `
        <div>
          <strong>${userName}</strong><br/>
          Ø§Ù„ØªØ§Ø±ÙŠØ®: ${data.date} - Ø§Ù„Ø³Ø§Ø¹Ø©: ${data.time} - Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ: ${data.studio}
        </div>
        <button class="btn btn-sm btn-success" onclick="approveBooking('${doc.id}')">âœ” Ù…ÙˆØ§ÙÙ‚Ø©</button>
      `;
      container.appendChild(card);
    });
  }

  // Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²
  async function approveBooking(id) {
    await db.collection("bookings").doc(id).update({
      status: "approved"
    });
    loadPendingBookings();
    loadTodayBookings();
    loadTomorrowBookings();
  }

  // Ø¹Ø±Ø¶ Ù…Ù† Ø³ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ…
  async function loadTodayBookings() {
    const container = document.getElementById("todayBookings");
    container.innerHTML = "";
    const today = new Date().toISOString().split("T")[0];

    const snapshot = await db.collection("bookings")
      .where("date", "==", today)
      .where("status", "==", "approved")
      .get();

    if (snapshot.empty) {
      container.innerHTML = "<p class='text-muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØ± Ø§Ù„ÙŠÙˆÙ….</p>";
      return;
    }

    snapshot.forEach(async (doc) => {
      const data = doc.data();
      const userSnap = await db.collection("users").doc(data.userId).get();
      const userName = userSnap.exists ? userSnap.data().name : "Ø£Ø³ØªØ§Ø° Ù…Ø¬Ù‡ÙˆÙ„";

      container.innerHTML += `
        <div class="border p-2 rounded mb-2 bg-white">
          <strong>${userName}</strong> - ${data.time} - Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ: ${data.studio}
        </div>
      `;
    });
  }

  // Ø¹Ø±Ø¶ Ù…Ù† Ø³ÙŠØµÙˆØ± ØºØ¯Ø§Ù‹
  async function loadTomorrowBookings() {
    const container = document.getElementById("tomorrowBookings");
    container.innerHTML = "";
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const dateStr = tomorrow.toISOString().split("T")[0];

    const snapshot = await db.collection("bookings")
      .where("date", "==", dateStr)
      .where("status", "==", "approved")
      .get();

    if (snapshot.empty) {
      container.innerHTML = "<p class='text-muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØ± ØºØ¯Ù‹Ø§.</p>";
      return;
    }

    snapshot.forEach(async (doc) => {
      const data = doc.data();
      const userSnap = await db.collection("users").doc(data.userId).get();
      const userName = userSnap.exists ? userSnap.data().name : "Ø£Ø³ØªØ§Ø° Ù…Ø¬Ù‡ÙˆÙ„";

      container.innerHTML += `
        <div class="border p-2 rounded mb-2 bg-white">
          <strong>${userName}</strong> - ${data.time} - Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ: ${data.studio}
        </div>
      `;
    });
  }

  // Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯
  document.getElementById("addTeacherForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const role = document.getElementById("role").value;
    const msg = document.getElementById("addTeacherMsg");

    try {
      const newUser = await auth.createUserWithEmailAndPassword(email, password);
      const uid = newUser.user.uid;

      await db.collection("users").doc(uid).set({
        name,
        role
      });

      msg.textContent = "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ù†Ø¬Ø§Ø­.";
      e.target.reset();
    } catch (error) {
      msg.textContent = "âŒ Ø®Ø·Ø£: " + error.message;
    }
  });
</script>
</body>
</html>
