<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Scudual</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBsBJNcvaJXiIcJShLiwa-WFtY-VUMGTuk",
      authDomain: "scudual.firebaseapp.com",
      projectId: "scudual"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();
    let editId = null;

    // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠØ© (Ø¨Ø¯ÙˆÙ† UTC) =====
    function formatLocalDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function lastDayStr(year, month1to12) {
      // month1to12: 1..12
      const last = new Date(year, month1to12, 0); // Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø´Ù‡Ø±
      return formatLocalDate(last);
    }

    // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª 12 Ø³Ø§Ø¹Ø© =====
    function to12h(one) {
      if (!one) return '';
      let [h, m] = one.split(':').map(Number);
      const suffix = h >= 12 ? 'Ù…' : 'Øµ';
      h = h % 12; if (h === 0) h = 12;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')} ${suffix}`;
    }
    function rangeTo12h(range) {
      if (!range || !range.includes('-')) return range || '';
      const [s, e] = range.split('-');
      return `${to12h(s)} - ${to12h(e)}`;
    }

    window.onload = () => {
      loadBookingRequests();
      loadShootRequests();
      loadTeachers();
      loadTeachersForRecurring();
      loadTeachersForManual();  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙÙŠ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠØ¯ÙˆÙŠ
      initMonthPicker();       // Ù„Ù„Ø³ÙƒØ´Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©
      loadMonthlyBookings();   // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    };
  </script>
</head>
<body class="bg-light py-4">
  <div class="container">

    <h3 class="text-center mb-4">ğŸ“‹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>

    <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="card mb-4">
      <div class="card-header bg-warning text-white">ğŸ“¥ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
      <div class="card-body" id="bookingRequests">
        <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
    </div>
<!-- Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
<div class="mb-3 text-end">
  <button class="btn btn-outline-primary" onclick="printTodayBookings()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
</div>

<!-- Ù…Ù† ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ… -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">ğŸ“… Ù…Ù† ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
  <div class="card-body" id="shootToday">
    <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>

<script>
  function printTodayBookings() {
    const todaySection = document.getElementById('shootToday').innerHTML;
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
      <html lang="ar" dir="rtl">
        <head>
          <title>Ø·Ø¨Ø§Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</title>
          <style>
            body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
            .booking { padding: 10px; border-bottom: 1px solid #ccc; }
          </style>
        </head>
        <body>
          <h2>ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
          ${todaySection}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  }
</script>
<!-- Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØºØ¯ -->
<div class="mb-3 text-end">
  <button class="btn btn-outline-success" onclick="printTomorrowBookings()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØºØ¯</button>
</div>

<!-- Ù…Ù† ÙŠØµÙˆØ± ØºØ¯Ù -->
<div class="card mb-4">
  <div class="card-header bg-info text-white">ğŸ“… Ù…Ù† ÙŠØµÙˆØ± ØºØ¯Ù</div>
  <div class="card-body" id="shootTomorrow">
    <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>
</div>

<script>
  function printTomorrowBookings() {
    const tomorrowSection = document.getElementById('shootTomorrow').innerHTML;
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
      <html lang="ar" dir="rtl">
        <head>
          <title>Ø·Ø¨Ø§Ø¹Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØºØ¯</title>
          <style>
            body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
            .booking { padding: 10px; border-bottom: 1px solid #ccc; }
          </style>
        </head>
        <body>
          <h2>ğŸ“… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØºØ¯</h2>
          ${tomorrowSection}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  }
</script>

    <!-- Ù…Ù† ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ… -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">ğŸ“… Ù…Ù† ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="card-body" id="shootToday">
        <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
    </div>

    <!-- Ù…Ù† ÙŠØµÙˆØ± ØºØ¯Ù -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">ğŸ“… Ù…Ù† ÙŠØµÙˆØ± ØºØ¯Ù</div>
      <div class="card-body" id="shootTomorrow">
        <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
    </div>

    <!-- Ù…Ù† ÙŠØµÙˆØ± Ø¨Ø¹Ø¯ ØºØ¯Ù -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">ğŸ“… Ù…Ù† ÙŠØµÙˆØ± Ø¨Ø¹Ø¯ ØºØ¯Ù</div>
      <div class="card-body" id="shootDayAfterTomorrow">
        <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
    </div>

    <!-- Ø­Ø¬Ø² Ø«Ø§Ø¨Øª Ø´Ù‡Ø±ÙŠ -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">ğŸ“† Ø­Ø¬Ø² Ø«Ø§Ø¨Øª Ø´Ù‡Ø±ÙŠ</div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Ø§Ù„Ø´Ù‡Ø± -->
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
            <select id="recMonth" class="form-select">
              <option value="8">Ø´Ù‡Ø± 8 (Ø¢Ø¨)</option>
              <option value="9">Ø´Ù‡Ø± 9 (Ø£ÙŠÙ„ÙˆÙ„)</option>
              <option value="10">Ø´Ù‡Ø± 10 (ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„)</option>
              <option value="11">Ø´Ù‡Ø± 11 (ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ)</option>
              <option value="12">Ø´Ù‡Ø± 12 (ÙƒØ§Ù†ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„)</option>
            </select>
          </div>
          <!-- Ø§Ù„Ø£Ø³ØªØ§Ø° -->
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
            <select id="recTeacher" class="form-select">
              <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
            </select>
          </div>
          <!-- Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ -->
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</label>
            <select id="recStudio" class="form-select">
              <option value="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
              <option value="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </div>
        </div>

        <!-- Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
        <div class="mt-3">
          <label class="form-label d-block">Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ…)</label>
          <div class="d-flex flex-wrap gap-2">
            <!-- JS: Ø§Ù„Ø£Ø­Ø¯=0 ... Ø§Ù„Ø³Ø¨Øª=6 -->
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-sat" value="6"><label class="form-check-label" for="w-sat">Ø§Ù„Ø³Ø¨Øª</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-sun" value="0"><label class="form-check-label" for="w-sun">Ø§Ù„Ø£Ø­Ø¯</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-mon" value="1"><label class="form-check-label" for="w-mon">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-tue" value="2"><label class="form-check-label" for="w-tue">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-wed" value="3"><label class="form-check-label" for="w-wed">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-thu" value="4"><label class="form-check-label" for="w-thu">Ø§Ù„Ø®Ù…ÙŠØ³</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-fri" value="5"><label class="form-check-label" for="w-fri">Ø§Ù„Ø¬Ù…Ø¹Ø©</label></div>
          </div>
        </div>

        <!-- Ø§Ù„ÙˆÙ‚Øª -->
        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
            <select id="recTime" class="form-select">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø©</option>
              <option value="10:00-12:00">10:00 - 12:00</option>
              <option value="12:00-14:00">12:00 - 14:00</option>
              <option value="14:00-16:00">14:00 - 16:00</option>
              <option value="16:00-18:00">16:00 - 18:00</option>
              <option value="18:00-20:00">18:00 - 20:00</option>
              <option value="20:00-22:00">20:00 - 22:00</option>
              <option value="22:00-00:00">22:00 - 00:00</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-success w-100" onclick="createMonthlyRecurring()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø«Ø§Ø¨Øª</button>
          </div>
        </div>

        <div id="recResult" class="mt-3"></div>
      </div>
    </div>
    <!-- Ù†Ù‡Ø§ÙŠØ© Ø­Ø¬Ø² Ø«Ø§Ø¨Øª Ø´Ù‡Ø±ÙŠ -->

    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
    <div class="mb-4 text-end">
      <button class="btn btn-success" onclick="showAddForm()">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø°</button>
    </div>
    <div id="formContainer"></div>
    <div class="table-responsive mb-5">
      <table class="table table-bordered table-striped text-center align-middle bg-white">
        <thead class="table-dark">
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¯ÙˆØ±</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="teachersTable">
          <tr><td colspan="3">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ -->
    <div class="card mb-4">
      <div class="card-header bg-dark text-white">ğŸ—“ï¸ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
            <select id="monthView" class="form-select">
              <option value="8">Ø´Ù‡Ø± 8 (Ø¢Ø¨)</option>
              <option value="9">Ø´Ù‡Ø± 9 (Ø£ÙŠÙ„ÙˆÙ„)</option>
              <option value="10">Ø´Ù‡Ø± 10 (ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„)</option>
              <option value="11">Ø´Ù‡Ø± 11 (ØªØ´Ø±ÙŠÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ)</option>
              <option value="12">Ø´Ù‡Ø± 12 (ÙƒØ§Ù†ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„)</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="loadMonthlyBookings()">Ø¹Ø±Ø¶</button>
          </div>
        </div>
        <div id="monthlyBookings" class="mt-3">
          <p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
      </div>
    </div>
    <!-- Ù†Ù‡Ø§ÙŠØ© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø± -->

    <!-- ====== Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ (Ø£ÙŠ ØªØ§Ø±ÙŠØ®) ====== -->
    <div class="card mb-4">
      <div class="card-header bg-warning-subtle">â• Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="manualDate" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø£Ø³ØªØ§Ø°</label>
            <select id="manualTeacher" class="form-select">
              <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</label>
            <select id="manualStudio" class="form-select">
              <option value="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
              <option value="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</label>
            <select id="manualTime" class="form-select">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø©</option>
              <option value="10:00-12:00">10:00 - 12:00</option>
              <option value="12:00-14:00">12:00 - 14:00</option>
              <option value="14:00-16:00">14:00 - 16:00</option>
              <option value="16:00-18:00">16:00 - 18:00</option>
              <option value="18:00-20:00">18:00 - 20:00</option>
              <option value="20:00-22:00">20:00 - 22:00</option>
              <option value="22:00-00:00">22:00 - 00:00</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-outline-primary w-100" onclick="createManualBooking()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø¬Ø²</button>
          </div>
        </div>
        <div id="manualResult" class="mt-3"></div>
      </div>
    </div>
    <!-- ====== Ù†Ù‡Ø§ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ ====== -->

  </div>

  <script>
    // ======== Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ========
    async function loadBookingRequests() {
      const ctr = document.getElementById('bookingRequests');
      ctr.innerHTML = `<p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>`;
      try {
        const snap = await db.collection('bookings')
          .where('status','==','pending')
          .get();
        if (snap.empty) {
          ctr.innerHTML = `<div class="alert alert-secondary">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>`;
          return;
        }
        let html = '';
        snap.docs.forEach(doc => {
          const d = doc.data();
          html += `
            <div class="d-flex justify-content-between align-items-center p-3 mb-2 border rounded bg-white">
              <div><strong>${d.userName}</strong> â€” ${d.date} â€” ${rangeTo12h(d.time)} â€” ${d.studio}</div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="approveBooking('${doc.id}')">âœ” Ù…ÙˆØ§ÙÙ‚Ø©</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </div>
            </div>`;
        });
        ctr.innerHTML = html;
      } catch(e) {
        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', e);
        ctr.innerHTML = `<div class="alert alert-danger">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.</div>`;
      }
    }
    async function approveBooking(id) {
      await db.collection('bookings').doc(id).update({ status: 'active' });
      loadBookingRequests();
      loadShootRequests();
      loadMonthlyBookings();
    }
    async function deleteBooking(id) {
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ')) return;
      await db.collection('bookings').doc(id).delete();
      loadBookingRequests();
      loadShootRequests();
      loadMonthlyBookings();
    }

    // ======== Ù…Ù† ÙŠØµÙˆØ± Ø§Ù„ÙŠÙˆÙ… / ØºØ¯Ù / Ø¨Ø¹Ø¯ ØºØ¯Ù ========
    async function loadShootRequests() {
      const today       = new Date();
      const tomorrow    = new Date(today);    tomorrow.setDate(tomorrow.getDate() + 1);
      const dayAfter    = new Date(today);    dayAfter.setDate(dayAfter.getDate() + 2);

      const dates = [
        { id: 'shootToday',            date: today },
        { id: 'shootTomorrow',         date: tomorrow },
        { id: 'shootDayAfterTomorrow', date: dayAfter }
      ];

      for (const { id, date } of dates) {
        const dateStr = formatLocalDate(date);
        const snap = await db.collection('bookings')
          .where('status','==','active')
          .where('date','==',dateStr)
          .get();
        renderShootList(id, snap);
      }
    }
    function renderShootList(containerId, snapshot) {
      const ctr = document.getElementById(containerId);
      if (snapshot.empty) {
        ctr.innerHTML = `<div class="alert alert-secondary">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</div>`;
        return;
      }
      let html = '';
      snapshot.docs.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-3 border rounded bg-white">
            <div><strong>${d.userName}</strong> â€” ${d.date} â€” ${rangeTo12h(d.time)} â€” ${d.studio}</div>
            <div>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>`;
      });
      ctr.innerHTML = html;
    }

    // ======== Ø­Ø¬Ø² Ø«Ø§Ø¨Øª Ø´Ù‡Ø±ÙŠ ========
    async function loadTeachersForRecurring() {
      const sel = document.getElementById('recTeacher');
      sel.innerHTML = `<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>`;
      const snap = await db.collection('users').where('role','==','teacher').get();
      if (snap.empty) { sel.innerHTML = `<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø©</option>`; return; }
      let html = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>`;
      snap.forEach(d=>{
        html += `<option value="${d.id}">${d.data().name}</option>`;
      });
      sel.innerHTML = html;
    }
    function getSelectedWeekdays() {
      return Array.from(document.querySelectorAll('#w-sat,#w-sun,#w-mon,#w-tue,#w-wed,#w-thu,#w-fri'))
        .filter(c => c.checked).map(c => parseInt(c.value,10));
    }
    function datesForMonth(year, monthNum, weekdays) {
      // monthNum: 1..12
      const res = [];
      const first = new Date(year, monthNum - 1, 1);
      const last  = new Date(year, monthNum, 0);
      for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
        if (weekdays.includes(d.getDay())) {
          // Ù†Ù†Ø³Ø® Ù„ØªÙØ§Ø¯ÙŠ Ù…ÙŠÙˆØªÙŠØ´Ù†
          res.push(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
        }
      }
      return res;
    }
    async function createMonthlyRecurring() {
      const month = parseInt(document.getElementById('recMonth').value, 10);   // 8..12
      const teacherId = document.getElementById('recTeacher').value;
      const studio = document.getElementById('recStudio').value;
      const timeRange = document.getElementById('recTime').value;
      const weekdays = getSelectedWeekdays();
      const resultBox = document.getElementById('recResult');
      resultBox.className = 'mt-3';
      resultBox.innerHTML = '';

      if (!teacherId || !timeRange || !studio || weekdays.length === 0) {
        resultBox.classList.add('text-danger');
        resultBox.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³ØªØ§Ø°ØŒ Ø§Ù„Ø£ÙŠØ§Ù…ØŒ Ø§Ù„ÙˆÙ‚ØªØŒ ÙˆØ§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ.';
        return;
      }

      // Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°
      const teacherDoc = await db.collection('users').doc(teacherId).get();
      const teacherName = teacherDoc.exists ? (teacherDoc.data().name || 'Ø£Ø³ØªØ§Ø°') : 'Ø£Ø³ØªØ§Ø°';

      const now = new Date();
      const year = now.getFullYear();
      const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      const allDates = datesForMonth(year, month, weekdays)
        .filter(d => d >= todayLocal); // Ø§Ù„ÙŠÙˆÙ… ÙˆÙ…Ø§ Ø¨Ø¹Ø¯Ù‡

      if (allDates.length === 0) {
        resultBox.classList.add('text-warning');
        resultBox.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠØ§Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.';
        return;
      }

      let created = 0, skipped = 0;
      for (const d of allDates) {
        const dateStr = formatLocalDate(d);

        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: (date/time/studio)
        const exist = await db.collection('bookings')
          .where('date','==',dateStr)
          .where('time','==',timeRange)
          .where('studio','==',studio)
          .get();

        if (!exist.empty) { skipped++; continue; }

        await db.collection('bookings').add({
          userId: teacherId,
          userName: teacherName,
          date: dateStr,
          time: timeRange,             // Ù†Ø®Ø²Ù† 24 Ø³Ø§Ø¹Ø© ÙˆÙ†Ø¹Ø±Ø¶ 12 Ø³Ø§Ø¹Ø©
          studio,
          status: 'active',            // ØªØ£ÙƒÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        created++;
      }

      resultBox.classList.add(created ? 'text-success' : 'text-warning');
      resultBox.textContent = `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${created} Ø­Ø¬Ø²/Ø­Ø¬ÙˆØ²Ø§Øª. ØªÙ… ØªØ®Ø·ÙŠ ${skipped} Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±.`;

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
      loadShootRequests();
      loadBookingRequests();
      loadMonthlyBookings();
    }

    // ======== Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©) ========
    function initMonthPicker() {
      // Ø¶Ø¨Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      const mv = document.getElementById('monthView');
      const monthNow = (new Date()).getMonth() + 1; // 1..12
      if ([8,9,10,11,12].includes(monthNow)) {
        mv.value = String(monthNow);
      } else {
        mv.value = '8'; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¶Ù…Ù† Ù‚Ø§Ø¦Ù…ØªÙƒ
      }
    }
    async function loadMonthlyBookings() {
      const box = document.getElementById('monthlyBookings');
      box.innerHTML = `<p class="text-muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>`;

      const month = parseInt(document.getElementById('monthView').value, 10);
      const year = (new Date()).getFullYear();
      const startStr = `${year}-${String(month).padStart(2,'0')}-01`;
      const endStr   = lastDayStr(year, month); // Ø¢Ø®Ø± ÙŠÙˆÙ… Ø¨Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø± (Ù…Ø­Ù„ÙŠ)

      try {
        // Ù†Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¶Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø± (Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø©)
        const snap = await db.collection('bookings')
          .where('date','>=', startStr)
          .where('date','<=', endStr)
          .get();

        if (snap.empty) {
          box.innerHTML = `<div class="alert alert-secondary">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>`;
          return;
        }

        // ÙØ±Ø² ÙˆØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…
        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        arr.sort((a,b) => (a.date || '').localeCompare(b.date || '') || (a.time || '').localeCompare(b.time || ''));

        let currentDate = '';
        let html = '';
        arr.forEach(it => {
          const badge = it.status === 'active' ? '<span class="badge bg-success ms-2">Ù…Ø¤ÙƒØ¯</span>'
                       : it.status === 'pending' ? '<span class="badge bg-warning text-dark ms-2">Ø¨Ø§Ù†ØªØ¸Ø§Ø±</span>'
                       : it.status === 'rejected' ? '<span class="badge bg-danger ms-2">Ù…Ø±ÙÙˆØ¶</span>'
                       : '<span class="badge bg-secondary ms-2">ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…</span>';
          if (it.date !== currentDate) {
            if (currentDate !== '') html += `</div>`; // Ø§ØºÙ„Ø§Ù‚ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚
            currentDate = it.date;
            html += `<h6 class="mt-3">ğŸ“… ${currentDate}</h6><div class="list-group">`;
          }
          html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>${it.userName || 'Ø£Ø³ØªØ§Ø°'}</strong> â€” ${rangeTo12h(it.time)} â€” ${it.studio} ${badge}
              </div>
              <div class="d-flex gap-2">
                ${it.status !== 'active' ? `<button class="btn btn-sm btn-success" onclick="approveBooking('${it.id}')">âœ” Ù…ÙˆØ§ÙÙ‚Ø©</button>` : ''}
                <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${it.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </div>
            </div>`;
        });
        if (currentDate !== '') html += `</div>`;
        box.innerHTML = html;
      } catch (e) {
        console.error('Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø±:', e);
        box.innerHTML = `<div class="alert alert-danger">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø±.</div>`;
      }
    }

    // ======== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ========
    async function loadTeachers() {
      const tb = document.getElementById('teachersTable');
      tb.innerHTML = '';
      try {
        const snap = await db.collection('users').where('role','==','teacher').get();
        if (snap.empty) { tb.innerHTML = '<tr><td colspan="3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø©.</td></tr>'; return; }
        snap.docs.forEach(doc => {
          const { name, role } = doc.data();
          tb.innerHTML += `
            <tr>
              <td>${name}</td>
              <td>${role}</td>
              <td>
                <button class="btn btn-sm btn-primary me-1" onclick="showEditForm('${doc.id}','${name}','${role}')">âœï¸</button>
                <button class="btn btn-sm btn-danger"  onclick="deleteTeacher('${doc.id}')">ğŸ—‘ï¸</button>
              </td>
            </tr>`;
        });
      } catch(e) {
        console.error('Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©:', e);
        tb.innerHTML = '<tr><td colspan="3">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
      }
    }
    function showAddForm() {
      editId = null;
      document.getElementById('formContainer').innerHTML = formHtml();
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function showEditForm(id,name,role) {
      editId = id;
      document.getElementById('formContainer').innerHTML = formHtml(name,role);
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function formHtml(name='',role='teacher') {
      return `
        <div class="card mb-4 shadow-sm"><div class="card-body">
          <h5 class="card-title">${editId?'ØªØ¹Ø¯ÙŠÙ„':'Ø¥Ø¶Ø§ÙØ©'} Ø£Ø³ØªØ§Ø°</h5>
          <div class="row g-3 align-items-end">
            <div class="col-md-6"><label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
              <input id="inpName" class="form-control" value="${name}"></div>
            <div class="col-md-4"><label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
              <select id="inpRole" class="form-select">
                <option value="teacher" ${role==='teacher'?'selected':''}>Ø£Ø³ØªØ§Ø°</option>
                <option value="admin"   ${role==='admin'?'selected':''}>Ù…Ø¯ÙŠØ±</option>
              </select></div>
            <div class="col-md-2 text-end">
              <button class="btn btn-${editId?'primary':'success'} w-100" onclick="${editId?'updateTeacher()':'addTeacher()'}()">
                ${editId?'ØªØ­Ø¯ÙŠØ«':'Ø¥Ø¶Ø§ÙØ©'}
              </button>
            </div>
          </div>
        </div></div>`;
    }
    async function addTeacher() {
      const name = document.getElementById('inpName').value.trim();
      if (!name) return alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù…');
      const uc = await auth.createUserWithEmailAndPassword(`${Date.now()}@example.com`, '123456');
      await db.collection('users').doc(uc.user.uid).set({ name, role:'teacher' });
      document.getElementById('formContainer').innerHTML = '';
      loadTeachers();
      loadTeachersForRecurring();
      loadTeachersForManual();
    }
    async function updateTeacher() {
      const name = document.getElementById('inpName').value.trim();
      if (!name) return alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù…');
      await db.collection('users').doc(editId).update({ name });
      document.getElementById('formContainer').innerHTML = '';
      loadTeachers();
      loadTeachersForRecurring();
      loadTeachersForManual();
    }
    async function deleteTeacher(id) {
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø°ØŸ')) return;
      await db.collection('users').doc(id).delete();
      loadTeachers();
      loadTeachersForRecurring();
      loadTeachersForManual();
    }

    // ======== ØªØ¹Ø¨Ø¦Ø© Ø£Ø³Ø§ØªØ°Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø² ========
    async function loadTeachersForManual() {
      const sel = document.getElementById('manualTeacher');
      sel.innerHTML = `<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>`;
      try {
        const snap = await db.collection('users').where('role','==','teacher').get();
        if (snap.empty) { sel.innerHTML = `<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø©</option>`; return; }
        let html = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</option>`;
        snap.forEach(d => { html += `<option value="${d.id}">${d.data().name}</option>`; });
        sel.innerHTML = html;
      } catch (e) {
        console.error('Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù„Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠØ¯ÙˆÙŠ:', e);
        sel.innerHTML = `<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>`;
      }
    }

    async function createManualBooking() {
      const dateStr   = document.getElementById('manualDate').value;   // yyyy-mm-dd Ù…Ù† input date
      const teacherId = document.getElementById('manualTeacher').value;
      const studio    = document.getElementById('manualStudio').value;
      const timeRange = document.getElementById('manualTime').value;
      const box       = document.getElementById('manualResult');

      box.className = 'mt-3';
      box.innerHTML = '';

      if (!dateStr || !teacherId || !studio || !timeRange) {
        box.classList.add('text-danger');
        box.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø£Ø³ØªØ§Ø°ØŒ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©ØŒ ÙˆØ§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ.';
        return;
      }

      try {
        // Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°
        const tDoc = await db.collection('users').doc(teacherId).get();
        const teacherName = tDoc.exists ? (tDoc.data().name || 'Ø£Ø³ØªØ§Ø°') : 'Ø£Ø³ØªØ§Ø°';

        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: (date/time/studio)
        const exist = await db.collection('bookings')
          .where('date','==',dateStr)
          .where('time','==',timeRange)
          .where('studio','==',studio)
          .get();
        if (!exist.empty) {
          box.classList.add('text-warning');
          box.textContent = 'âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¬ÙˆØ² Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª/Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ.';
          return;
        }

        await db.collection('bookings').add({
          userId: teacherId,
          userName: teacherName,
          date: dateStr,
          time: timeRange,               // Ù†Ø®Ø²Ù† 24 Ø³Ø§Ø¹Ø© ÙˆÙ†Ø¹Ø±Ø¶ 12 Ø³Ø§Ø¹Ø©
          studio,
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        box.classList.add('text-success');
        box.textContent = 'âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­.';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        loadShootRequests();
        loadMonthlyBookings();
        loadBookingRequests();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        // document.getElementById('manualDate').value = '';
        document.getElementById('manualTeacher').value = '';
        document.getElementById('manualTime').value = '';
        document.getElementById('manualStudio').value = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
      } catch (e) {
        console.error('Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠØ¯ÙˆÙŠ:', e);
        box.classList.add('text-danger');
        box.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø².';
      }
    }
    // ======== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙŠØ¯ÙˆÙŠ ========
  </script>
</body>
</html>
