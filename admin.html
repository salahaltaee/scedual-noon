<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ููุญุฉ ุงูุชุญูู - Scudual</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBsBJNcvaJXiIcJShLiwa-WFtY-VUMGTuk",
      authDomain: "scudual.firebaseapp.com",
      projectId: "scudual"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();
    let editId = null;

    window.onload = () => {
      loadBookingRequests();
      loadShootRequests();
      loadTeachers();            // ููุฌุฏูู
      loadTeachersForRecurring(); // ูุณููููุชุฑ ุงูุญุฌุฒ ุงูุซุงุจุช
    };

    // ุฃุฏูุงุช ุชูุณูู ุงูููุช 12 ุณุงุนุฉ ููุนุฑุถ ููุท
    function to12h(one) {
      let [h, m] = one.split(':').map(Number);
      const suffix = h >= 12 ? 'ู' : 'ุต';
      h = h % 12; if (h === 0) h = 12;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')} ${suffix}`;
    }
    function rangeTo12h(range) {
      if (!range || !range.includes('-')) return range;
      const [s, e] = range.split('-');
      return `${to12h(s)} - ${to12h(e)}`;
    }
  </script>
</head>
<body class="bg-light py-4">
  <div class="container">

    <h3 class="text-center mb-4">๐ ููุญุฉ ุงูุชุญูู</h3>

    <!-- ุทูุจุงุช ุงูุชุตููุฑ ุงูุฌุฏูุฏุฉ -->
    <div class="card mb-4">
      <div class="card-header bg-warning text-white">๐ฅ ุทูุจุงุช ุงูุชุตููุฑ ุงูุฌุฏูุฏุฉ</div>
      <div class="card-body" id="bookingRequests">
        <p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>
      </div>
    </div>

    <!-- ูู ูุตูุฑ ุงูููู -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">๐ ูู ูุตูุฑ ุงูููู</div>
      <div class="card-body" id="shootToday">
        <p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>
      </div>
    </div>

    <!-- ูู ูุตูุฑ ุบุฏู -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">๐ ูู ูุตูุฑ ุบุฏู</div>
      <div class="card-body" id="shootTomorrow">
        <p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>
      </div>
    </div>

    <!-- ูู ูุตูุฑ ุจุนุฏ ุบุฏู -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">๐ ูู ูุตูุฑ ุจุนุฏ ุบุฏู</div>
      <div class="card-body" id="shootDayAfterTomorrow">
        <p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>
      </div>
    </div>

    <!-- ุญุฌุฒ ุซุงุจุช ุดูุฑู -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">๐ ุญุฌุฒ ุซุงุจุช ุดูุฑู</div>
      <div class="card-body">
        <div class="row g-3">
          <!-- ุงูุดูุฑ -->
          <div class="col-md-3">
            <label class="form-label">ุงูุดูุฑ</label>
            <select id="recMonth" class="form-select">
              <option value="8">ุดูุฑ 8 (ุขุจ)</option>
              <option value="9">ุดูุฑ 9 (ุฃูููู)</option>
              <option value="10">ุดูุฑ 10 (ุชุดุฑูู ุงูุฃูู)</option>
              <option value="11">ุดูุฑ 11 (ุชุดุฑูู ุงูุซุงูู)</option>
              <option value="12">ุดูุฑ 12 (ูุงููู ุงูุฃูู)</option>
            </select>
          </div>
          <!-- ุงูุฃุณุชุงุฐ -->
          <div class="col-md-4">
            <label class="form-label">ุงูุฃุณุชุงุฐ</label>
            <select id="recTeacher" class="form-select">
              <option value="">ุฌุงุฑู ุงูุชุญููู...</option>
            </select>
          </div>
          <!-- ุงูุงุณุชูุฏูู -->
          <div class="col-md-3">
            <label class="form-label">ุงูุงุณุชูุฏูู</label>
            <select id="recStudio" class="form-select">
              <option value="ุงูุฑุฆูุณู">ุงูุฑุฆูุณู</option>
              <option value="ุงูุซุงููู">ุงูุซุงููู</option>
            </select>
          </div>
        </div>

        <!-- ุฃูุงู ุงูุฃุณุจูุน -->
        <div class="mt-3">
          <label class="form-label d-block">ุฃูุงู ุงูุฃุณุจูุน (ูููู ุงุฎุชูุงุฑ ุฃูุซุฑ ูู ููู)</label>
          <div class="d-flex flex-wrap gap-2">
            <!-- ููุงุญุธุฉ: ุฃุฑูุงู ุงูุฃูุงู ุญุณุจ JS: ุงูุฃุญุฏ=0 ... ุงูุณุจุช=6 -->
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-sat" value="6"><label class="form-check-label" for="w-sat">ุงูุณุจุช</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-sun" value="0"><label class="form-check-label" for="w-sun">ุงูุฃุญุฏ</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-mon" value="1"><label class="form-check-label" for="w-mon">ุงูุฅุซููู</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-tue" value="2"><label class="form-check-label" for="w-tue">ุงูุซูุงุซุงุก</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-wed" value="3"><label class="form-check-label" for="w-wed">ุงูุฃุฑุจุนุงุก</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-thu" value="4"><label class="form-check-label" for="w-thu">ุงูุฎููุณ</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="w-fri" value="5"><label class="form-check-label" for="w-fri">ุงูุฌูุนุฉ</label></div>
          </div>
        </div>

        <!-- ุงูููุช -->
        <div class="row g-3 mt-2">
          <div class="col-md-4">
            <label class="form-label">ุงููุชุฑุฉ ุงูุฒูููุฉ</label>
            <select id="recTime" class="form-select">
              <option value="">ุงุฎุชุฑ ุงููุชุฑุฉ</option>
              <option value="10:00-12:00">10:00 - 12:00</option>
              <option value="12:00-14:00">12:00 - 14:00</option>
              <option value="14:00-16:00">14:00 - 16:00</option>
              <option value="16:00-18:00">16:00 - 18:00</option>
              <option value="18:00-20:00">18:00 - 20:00</option>
              <option value="20:00-22:00">20:00 - 22:00</option>
              <option value="22:00-00:00">22:00 - 00:00</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-success w-100" onclick="createMonthlyRecurring()">ุชุซุจูุช ุงูุญุฌุฒ ุงูุซุงุจุช</button>
          </div>
        </div>

        <div id="recResult" class="mt-3"></div>
      </div>
    </div>
    <!-- ููุงูุฉ ุญุฌุฒ ุซุงุจุช ุดูุฑู -->

    <!-- ุฅุฏุงุฑุฉ ุงูุฃุณุงุชุฐุฉ -->
    <div class="mb-4 text-end">
      <button class="btn btn-success" onclick="showAddForm()">โ ุฅุถุงูุฉ ุฃุณุชุงุฐ</button>
    </div>
    <div id="formContainer"></div>
    <div class="table-responsive mb-5">
      <table class="table table-bordered table-striped text-center align-middle bg-white">
        <thead class="table-dark">
          <tr>
            <th>ุงูุงุณู</th>
            <th>ุงูุฏูุฑ</th>
            <th>ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="teachersTable">
          <tr><td colspan="3">ุฌุงุฑู ุงูุชุญููู...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    // ======== ุทูุจุงุช ุงูุชุตููุฑ ุงูุฌุฏูุฏุฉ ========
    async function loadBookingRequests() {
      const ctr = document.getElementById('bookingRequests');
      ctr.innerHTML = `<p class="text-muted">ุฌุงุฑู ุงูุชุญููู...</p>`;
      try {
        const snap = await db.collection('bookings')
          .where('status','==','pending')
          .get();
        if (snap.empty) {
          ctr.innerHTML = `<div class="alert alert-secondary">ูุง ุชูุฌุฏ ุทูุจุงุช ุฌุฏูุฏุฉ</div>`;
          return;
        }
        let html = '';
        snap.docs.forEach(doc => {
          const d = doc.data();
          html += `
            <div class="d-flex justify-content-between align-items-center p-3 mb-2 border rounded bg-white">
              <div><strong>${d.userName}</strong> โ ${d.date} โ ${rangeTo12h(d.time)} โ ${d.studio}</div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="approveBooking('${doc.id}')">โ ููุงููุฉ</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${doc.id}')">๐๏ธ ุญุฐู</button>
              </div>
            </div>`;
        });
        ctr.innerHTML = html;
      } catch(e) {
        console.error('ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุทูุจุงุช:', e);
        ctr.innerHTML = `<div class="alert alert-danger">ูุดู ุงูุชุญููู.</div>`;
      }
    }
    async function approveBooking(id) {
      await db.collection('bookings').doc(id).update({ status: 'active' });
      loadBookingRequests();
      loadShootRequests();
    }
    async function deleteBooking(id) {
      if (!confirm('ุชุฃููุฏ ุญุฐู ุงูููุนุฏุ')) return;
      await db.collection('bookings').doc(id).delete();
      loadBookingRequests();
      loadShootRequests();
    }

    // ======== ูู ูุตูุฑ ุงูููู / ุบุฏู / ุจุนุฏ ุบุฏู ========
    async function loadShootRequests() {
      const today       = new Date();
      const tomorrow    = new Date(today);    tomorrow.setDate(tomorrow.getDate() + 1);
      const dayAfter    = new Date(today);    dayAfter.setDate(dayAfter.getDate() + 2);

      const dates = [
        { id: 'shootToday',            date: today },
        { id: 'shootTomorrow',         date: tomorrow },
        { id: 'shootDayAfterTomorrow', date: dayAfter }
      ];

      for (const { id, date } of dates) {
        const dateStr = date.toISOString().split('T')[0];
        const snap = await db.collection('bookings')
          .where('status','==','active')
          .where('date','==',dateStr)
          .get();
        renderShootList(id, snap);
      }
    }
    function renderShootList(containerId, snapshot) {
      const ctr = document.getElementById(containerId);
      if (snapshot.empty) {
        ctr.innerHTML = `<div class="alert alert-secondary">ูุง ุชูุฌุฏ ุญุฌูุฒุงุช</div>`;
        return;
      }
      let html = '';
      snapshot.docs.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="d-flex justify-content-between align-items-center mb-2 p-3 border rounded bg-white">
            <div><strong>${d.userName}</strong> โ ${d.date} โ ${rangeTo12h(d.time)} โ ${d.studio}</div>
            <div>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${doc.id}')">๐๏ธ ุญุฐู</button>
            </div>
          </div>`;
      });
      ctr.innerHTML = html;
    }

    // ======== ุญุฌุฒ ุซุงุจุช ุดูุฑู ========
    async function loadTeachersForRecurring() {
      const sel = document.getElementById('recTeacher');
      sel.innerHTML = `<option value="">ุฌุงุฑู ุงูุชุญููู...</option>`;
      const snap = await db.collection('users').where('role','==','teacher').get();
      if (snap.empty) { sel.innerHTML = `<option value="">ูุง ููุฌุฏ ุฃุณุงุชุฐุฉ</option>`; return; }
      let html = `<option value="">ุงุฎุชุฑ ุงูุฃุณุชุงุฐ</option>`;
      snap.forEach(d=>{
        html += `<option value="${d.id}">${d.data().name}</option>`;
      });
      sel.innerHTML = html;
    }

    function getSelectedWeekdays() {
      return Array.from(document.querySelectorAll('#w-sat,#w-sun,#w-mon,#w-tue,#w-wed,#w-thu,#w-fri'))
        .filter(c => c.checked).map(c => parseInt(c.value,10));
    }

    // ุฑุฌูุน ูู ุงูุชูุงุฑูุฎ ุฏุงุฎู ุดูุฑ ูุนููู ุชูุงูู ุฃูุงู ุงูุฃุณุจูุน ุงููุฎุชุงุฑุฉ
    function datesForMonth(year, monthNum, weekdays) {
      // monthNum: 1..12  | ููุง ูุณุชุนูู 1-based
      const res = [];
      const first = new Date(year, monthNum - 1, 1);
      const last  = new Date(year, monthNum, 0); // ุงูููู ุงูุฃุฎูุฑ
      for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
        if (weekdays.includes(d.getDay())) {
          res.push(new Date(d));
        }
      }
      return res;
    }

    async function createMonthlyRecurring() {
      const month = parseInt(document.getElementById('recMonth').value, 10);   // 8..12
      const teacherId = document.getElementById('recTeacher').value;
      const studio = document.getElementById('recStudio').value;
      const timeRange = document.getElementById('recTime').value;
      const weekdays = getSelectedWeekdays();
      const resultBox = document.getElementById('recResult');
      resultBox.className = 'mt-3';
      resultBox.innerHTML = '';

      if (!teacherId || !timeRange || !studio || weekdays.length === 0) {
        resultBox.classList.add('text-danger');
        resultBox.textContent = 'ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฃุณุชุงุฐุ ุงูุฃูุงูุ ุงูููุชุ ูุงูุงุณุชูุฏูู.';
        return;
      }

      // ูุฌูุจ ุงุณู ุงูุฃุณุชุงุฐ
      const teacherDoc = await db.collection('users').doc(teacherId).get();
      const teacherName = teacherDoc.exists ? (teacherDoc.data().name || 'ุฃุณุชุงุฐ') : 'ุฃุณุชุงุฐ';

      const year = (new Date()).getFullYear();
      const allDates = datesForMonth(year, month, weekdays)
        .filter(d => d >= new Date(new Date().toDateString())); // ุงูููู ููุง ุจุนุฏู ููุท

      if (allDates.length === 0) {
        resultBox.classList.add('text-warning');
        resultBox.textContent = 'ูุง ุชูุฌุฏ ุฃูุงู ูุทุงุจูุฉ ูู ูุฐุง ุงูุดูุฑ.';
        return;
      }

      let created = 0, skipped = 0;
      for (const d of allDates) {
        const dateStr = d.toISOString().split('T')[0];

        // ููุน ุงูุชูุฑุงุฑ: ุชุญูู ูู ูุฌูุฏ ููุณ (date/time/studio)
        const exist = await db.collection('bookings')
          .where('date','==',dateStr)
          .where('time','==',timeRange)
          .where('studio','==',studio)
          .get();

        if (!exist.empty) { skipped++; continue; }

        await db.collection('bookings').add({
          userId: teacherId,
          userName: teacherName,
          date: dateStr,
          time: timeRange,             // ูุฎุฒู 24 ุณุงุนุฉ ููุนุฑุถ 12 ุณุงุนุฉ
          studio,
          status: 'active',            // ุชุฃููุฏ ูุจุงุดุฑ
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        created++;
      }

      resultBox.classList.add(created ? 'text-success' : 'text-warning');
      resultBox.textContent = `ุชู ุฅูุดุงุก ${created} ุญุฌุฒ/ุญุฌูุฒุงุช. ุชู ุชุฎุทู ${skipped} ุจุณุจุจ ุงูุชูุฑุงุฑ.`;

      // ุญุฏุซ ุงูููุงุฆู
      loadShootRequests();
      loadBookingRequests();
    }
    // ======== ููุงูุฉ ุญุฌุฒ ุซุงุจุช ุดูุฑู ========

    // ======== ุฅุฏุงุฑุฉ ุงูุฃุณุงุชุฐุฉ (ููุง ูุงูุช) ========
    async function loadTeachers() {
      const tb = document.getElementById('teachersTable');
      tb.innerHTML = '';
      try {
        const snap = await db.collection('users').where('role','==','teacher').get();
        if (snap.empty) { tb.innerHTML = '<tr><td colspan="3">ูุง ููุฌุฏ ุฃุณุงุชุฐุฉ.</td></tr>'; return; }
        snap.docs.forEach(doc => {
          const { name, role } = doc.data();
          tb.innerHTML += `
            <tr>
              <td>${name}</td>
              <td>${role}</td>
              <td>
                <button class="btn btn-sm btn-primary me-1" onclick="showEditForm('${doc.id}','${name}','${role}')">โ๏ธ</button>
                <button class="btn btn-sm btn-danger"  onclick="deleteTeacher('${doc.id}')">๐๏ธ</button>
              </td>
            </tr>`;
        });
      } catch(e) {
        console.error('ุฎุทุฃ ุชุญููู ุงูุฃุณุงุชุฐุฉ:', e);
        tb.innerHTML = '<tr><td colspan="3">ูุดู ุงูุชุญููู</td></tr>';
      }
    }
    function showAddForm() {
      editId = null;
      document.getElementById('formContainer').innerHTML = formHtml();
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function showEditForm(id,name,role) {
      editId = id;
      document.getElementById('formContainer').innerHTML = formHtml(name,role);
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function formHtml(name='',role='teacher') {
      return `
        <div class="card mb-4 shadow-sm"><div class="card-body">
          <h5 class="card-title">${editId?'ุชุนุฏูู':'ุฅุถุงูุฉ'} ุฃุณุชุงุฐ</h5>
          <div class="row g-3 align-items-end">
            <div class="col-md-6"><label class="form-label">ุงูุงุณู</label>
              <input id="inpName" class="form-control" value="${name}"></div>
            <div class="col-md-4"><label class="form-label">ุงูุฏูุฑ</label>
              <select id="inpRole" class="form-select">
                <option value="teacher" ${role==='teacher'?'selected':''}>ุฃุณุชุงุฐ</option>
                <option value="admin"   ${role==='admin'?'selected':''}>ูุฏูุฑ</option>
              </select></div>
            <div class="col-md-2 text-end">
              <button class="btn btn-${editId?'primary':'success'} w-100" onclick="${editId?'updateTeacher()':'addTeacher()'}()">
                ${editId?'ุชุญุฏูุซ':'ุฅุถุงูุฉ'}
              </button>
            </div>
          </div>
        </div></div>`;
    }
    async function addTeacher() {
      const name = document.getElementById('inpName').value.trim();
      if (!name) return alert('ูุฑุฌู ุชุนุจุฆุฉ ุงูุงุณู');
      const uc = await auth.createUserWithEmailAndPassword(`${Date.now()}@example.com`, '123456');
      await db.collection('users').doc(uc.user.uid).set({ name, role:'teacher' });
      document.getElementById('formContainer').innerHTML = '';
      loadTeachers();
      loadTeachersForRecurring();
    }
    async function updateTeacher() {
      const name = document.getElementById('inpName').value.trim();
      if (!name) return alert('ูุฑุฌู ุชุนุจุฆุฉ ุงูุงุณู');
      await db.collection('users').doc(editId).update({ name });
      document.getElementById('formContainer').innerHTML = '';
      loadTeachers();
      loadTeachersForRecurring();
    }
    async function deleteTeacher(id) {
      if (!confirm('ุชุฃููุฏ ุญุฐู ุงูุฃุณุชุงุฐุ')) return;
      await db.collection('users').doc(id).delete();
      loadTeachers();
      loadTeachersForRecurring();
    }
    // ======== ููุงูุฉ ุฅุฏุงุฑุฉ ุงูุฃุณุงุชุฐุฉ ========
  </script>
</body>
</html>
