<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الدخول - Scudual</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body{background:#f6f7fb}
    .card{box-shadow:0 2px 12px rgba(0,0,0,.08)}
  </style>
</head>
<body class="py-5">
  <div class="container" style="max-width:520px">
    <div class="text-center mb-4">
      <h4 class="mb-1">تسجيل الدخول</h4>
      <div class="text-muted small">أدخل بريدك وكلمة المرور التي أضافها المدير</div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">البريد الإلكتروني</label>
          <input id="email" type="email" class="form-control" placeholder="example@email.com" autofocus>
        </div>
        <div class="mb-2">
          <label class="form-label">كلمة المرور</label>
          <input id="password" type="password" class="form-control" placeholder="••••••••">
        </div>
        <div class="text-end mb-3">
          <button class="btn btn-link p-0" onclick="sendReset()">نسيت كلمة المرور؟</button>
        </div>
        <button class="btn btn-primary w-100" onclick="signIn()">تسجيل الدخول</button>
        <div id="msg" class="mt-3"></div>
      </div>
    </div>

    <div class="text-center mt-4 text-muted small">
      © استوديو نون
    </div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBsBJNcvaJXiIcJShLiwa-WFtY-VUMGTuk",
      authDomain: "scudual.firebaseapp.com",
      projectId: "scudual"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // إذا مسجّل مسبقًا → للصفحة الرئيسة للأستاذ
    auth.onAuthStateChanged(u => {
      if(u) window.location.href = 'teacher.html';
    });

    function showMsg(text, cls='alert-danger'){
      const box = document.getElementById('msg');
      box.className = 'alert '+cls;
      box.textContent = text;
    }

    async function signIn(){
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value;
      if(!email || !pass){ return showMsg('يرجى إدخال البريد وكلمة المرور','alert-warning'); }

      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);

        // ربط هذا الحساب بوثيقة المدرّس (users) عبر authUid إن لم تكن مربوطة
        try{
          // ابحث وثيقة teacher بهذا البريد إن كانت موجودة (اختياري)،
          // أو وثيقة uid == auth.uid، ثم خزّن authUid داخلها
          const uid = cred.user.uid;

          // 1) لو عندنا users/uid
          const doc = await db.collection('users').doc(uid).get();
          if(doc.exists){
            if(doc.data().authUid !== uid){
              await db.collection('users').doc(uid).update({ authUid: uid });
            }
          }else{
            // 2) جرّب العثور على Teacher بنفس البريد (لو المدير خزّنه مسبقًا)
            const q = await db.collection('users')
              .where('role','==','teacher')
              .where('email','==',email)
              .limit(1).get();

            if(!q.empty){
              const ref = q.docs[0].ref;
              await ref.update({ authUid: uid });
            }
          }
        }catch(e){ /* ربط اختياري – نتجاهل الخطأ */ }

        window.location.href = 'teacher.html';
      }catch(e){
        console.error(e);
        // رسائل أوضح لبعض الأخطاء
        if(e.code === 'auth/user-not-found') return showMsg('الحساب غير موجود. تأكد من البريد.');
        if(e.code === 'auth/wrong-password') return showMsg('كلمة المرور غير صحيحة.');
        if(e.code === 'auth/too-many-requests') return showMsg('محاولات كثيرة. أعد المحاولة لاحقًا.');
        showMsg('فشل تسجيل الدخول: '+ e.message);
      }
    }

    async function sendReset(){
      const email = document.getElementById('email').value.trim();
      if(!email) return showMsg('أدخل بريدك لإرسال رابط الاسترجاع','alert-warning');
      try{
        await auth.sendPasswordResetEmail(email);
        showMsg('تم إرسال رابط استرجاع كلمة المرور إلى بريدك.','alert-success');
      }catch(e){
        console.error(e);
        showMsg('تعذر إرسال الرابط: ' + e.message);
      }
    }
  </script>
</body>
</html>
