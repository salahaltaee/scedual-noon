<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆØ²Ø±ÙŠØ© - Scudual</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body{background:#f6f7fb;}
    .card{box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body class="py-4">
  <div class="container" style="max-width:1100px">
    <h3 class="text-center mb-4">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆØ²Ø±ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„)</h3>

    <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ -->
    <div class="alert alert-warning">
      âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ¹Ù…Ù„ Ù…Ù† Ø§Ù„ÙØ±ÙˆÙ†Øª ÙÙ‚Ø·. Ù„Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù€ <span class="mono">Authentication</span>
      Ù†Ø³ØªØ¹Ù…Ù„ <strong>ØªØ·Ø¨ÙŠÙ‚ Firebase Ø«Ø§Ù†ÙˆÙŠ</strong> Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¨Ø¯Ù‘Ù„ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ØªØµÙØ­. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore/Auth
      Ù„Ø¯ÙŠÙƒ Ø¨Ø£Ù†Ù‡Ø§ ØªØ³Ù…Ø­ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ±. Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ ÙŠÙÙØ¶Ù‘ÙÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± (Admin SDK).
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="addName" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="addEmail" type="email" class="form-control" placeholder="teacher@example.com">
          </div>
          <div class="col-md-3">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="addPassword" type="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <div class="col-md-1">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
            <select id="addRole" class="form-select">
              <option value="teacher" selected>Ø£Ø³ØªØ§Ø°</option>
              <option value="admin">Ù…Ø¯ÙŠØ±</option>
            </select>
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-success" onclick="addTeacher()">Ø¥Ø¶Ø§ÙØ©</button>
          <span id="addMsg" class="ms-3"></span>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© -->
    <div class="card mb-4">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</span>
        <button class="btn btn-light btn-sm" onclick="loadTeachers()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <div class="card-body table-responsive">
        <table class="table table-striped align-middle text-center bg-white">
          <thead class="table-light">
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th style="width:280px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="teachersTable">
            <tr><td colspan="4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³ØªØ§Ø° -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³ØªØ§Ø°</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ù…Ø¹Ø±Ù (UID)</label>
            <input id="editUid" class="form-control mono" placeholder="Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„" readonly>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="editName" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
            <select id="editRole" class="form-select">
              <option value="teacher">Ø£Ø³ØªØ§Ø°</option>
              <option value="admin">Ù…Ø¯ÙŠØ±</option>
            </select>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="updateTeacher()">Ø­ÙØ¸</button>
          </div>
        </div>
        <div id="editMsg" class="mt-3"></div>
      </div>
    </div>

    <!-- ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ) -->
    <div class="card">
      <div class="card-header bg-info text-white">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input id="pwEmail" type="email" class="form-control" placeholder="teacher@example.com">
          </div>
          <div class="col-md-4">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
            <input id="pwOld" type="password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
          </div>
          <div class="col-md-3">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</label>
            <input id="pwNew" type="password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-info w-100" onclick="changePassword()">ØªØºÙŠÙŠØ±</button>
          </div>
        </div>
        <div id="pwMsg" class="mt-3"></div>
      </div>
    </div>

  </div>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù‚Ø±Ø§Ø¡Ø©/ÙƒØªØ§Ø¨Ø© Firestore)
    const firebaseConfig = {
      apiKey: "AIzaSyBsBJNcvaJXiIcJShLiwa-WFtY-VUMGTuk",
      authDomain: "scudual.firebaseapp.com",
      projectId: "scudual"
    };
    const mainApp = firebase.initializeApp(firebaseConfig);
    const db = mainApp.firestore();

    // ØªØ·Ø¨ÙŠÙ‚ Ø«Ø§Ù†ÙˆÙŠ Ù„Ø¥Ø¯Ø§Ø±Ø© Authentication Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    const adminApp = firebase.initializeApp(firebaseConfig, 'adminApp');
    const adminAuth = adminApp.auth();

    const teachersTable = document.getElementById('teachersTable');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
    async function loadTeachers() {
      teachersTable.innerHTML = `<tr><td colspan="4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;
      try {
        const snap = await db.collection('users').where('role','in',['teacher','admin']).get();
        if (snap.empty) {
          teachersTable.innerHTML = `<tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø©.</td></tr>`;
          return;
        }
        teachersTable.innerHTML = '';
        snap.forEach(doc => {
          const {name='', role='teacher', email=''} = doc.data();
          teachersTable.innerHTML += `
            <tr>
              <td>${name}</td>
              <td>${email || '<span class="text-muted">â€”</span>'}</td>
              <td>${role}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="fillEdit('${doc.id}','${escapeHtml(name)}','${role}')">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTeacherDoc('${doc.id}')">Ø­Ø°Ù (Firestore)</button>
              </td>
            </tr>
          `;
        });
      } catch (e) {
        console.error(e);
        teachersTable.innerHTML = `<tr><td colspan="4" class="text-danger">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`;
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° + Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Auth Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ
    async function addTeacher() {
      const name = document.getElementById('addName').value.trim();
      const email = document.getElementById('addEmail').value.trim();
      const pass  = document.getElementById('addPassword').value;
      const role  = document.getElementById('addRole').value;
      const msgEl = document.getElementById('addMsg');
      msgEl.className=''; msgEl.textContent='';

      if (!name || !email || !pass) {
        msgEl.className='text-danger'; msgEl.textContent='ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        return;
      }

      try {
        // 1) Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Auth (Ø³ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ adminApp ÙÙ‚Ø·)
        const cred = await adminAuth.createUserWithEmailAndPassword(email, pass);
        const uid = cred.user.uid;

        // 2) Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Firestore
        await db.collection('users').doc(uid).set({ name, role, email });

        // 3) ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ (Ù„Ù„Ø¨Ù‚Ø§Ø¡ Ù†Ø¸ÙŠÙ)
        await adminAuth.signOut();

        msgEl.className='text-success'; msgEl.textContent='âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¥Ø¶Ø§ÙØªÙ‡';
        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('addName').value = '';
        document.getElementById('addEmail').value = '';
        document.getElementById('addPassword').value = '';
        document.getElementById('addRole').value = 'teacher';

        loadTeachers();
      } catch (e) {
        console.error(e);
        msgEl.className='text-danger';
        msgEl.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ' + (e?.message || e);
      }
    }

    // ØªØ¹Ø¨Ø¦Ø© ÙÙˆØ±Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    function fillEdit(uid, name, role) {
      document.getElementById('editUid').value = uid;
      document.getElementById('editName').value = unescapeHtml(name);
      document.getElementById('editRole').value = role || 'teacher';
      document.getElementById('editMsg').innerHTML = '';
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
    }

    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Firestore ÙÙ‚Ø·)
    async function updateTeacher() {
      const uid  = document.getElementById('editUid').value.trim();
      const name = document.getElementById('editName').value.trim();
      const role = document.getElementById('editRole').value;
      const msg  = document.getElementById('editMsg');

      msg.className=''; msg.textContent='';
      if (!uid || !name) { msg.className='text-danger'; msg.textContent='Ø§Ø®ØªØ± Ø£Ø³ØªØ§Ø°Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø«Ù… Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¯ÙˆØ±'; return; }

      try {
        await db.collection('users').doc(uid).update({ name, role });
        msg.className='text-success'; msg.textContent='âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
        loadTeachers();
      } catch (e) {
        console.error(e);
        msg.className='text-danger'; msg.textContent='ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
      }
    }

    // Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Firestore (Ù„Ø§ ÙŠØ­Ø°Ù Ø­Ø³Ø§Ø¨ Auth)
    async function deleteTeacherDoc(uid) {
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ù† FirestoreØŸ')) return;
      try {
        await db.collection('users').doc(uid).delete();
        loadTeachers();
      } catch (e) {
        console.error(e);
        alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
      }
    }

    // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ (Ù†Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ Ø¨Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨)
    async function changePassword() {
      const email = document.getElementById('pwEmail').value.trim();
      const oldPw = document.getElementById('pwOld').value;
      const newPw = document.getElementById('pwNew').value;
      const msgEl = document.getElementById('pwMsg');

      msgEl.className=''; msgEl.textContent='';

      if (!email || !oldPw || !newPw) {
        msgEl.className='text-danger'; msgEl.textContent='Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
        return;
      }

      try {
        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙÙŠ adminApp ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‡Ø¯Ù
        await adminAuth.signInWithEmailAndPassword(email, oldPw);
        await adminAuth.currentUser.updatePassword(newPw);
        await adminAuth.signOut();
        msgEl.className='text-success'; msgEl.textContent='âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
        document.getElementById('pwEmail').value='';
        document.getElementById('pwOld').value='';
        document.getElementById('pwNew').value='';
      } catch (e) {
        console.error(e);
        msgEl.className='text-danger';
        msgEl.textContent='ØªØ¹Ø°Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ' + (e?.message || e);
      }
    }

    // Helpers: HTML escaping
    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}
    function unescapeHtml(s){const e=document.createElement('textarea'); e.innerHTML=s; return e.value;}

    // Ø¨Ø¯Ø¡
    window.onload = loadTeachers;
  </script>
</body>
</html>
